#!/usr/bin/env python3
"""Stream Kokoro TTS audio as raw PCM to stdout, one chunk at a time."""

import asyncio
import sys
import numpy as np
from kokoro_onnx import Kokoro

async def main():
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--model", required=True)
    parser.add_argument("--voices", required=True)
    parser.add_argument("--voice", default="af_heart")
    parser.add_argument("--speed", type=float, default=1.0)
    parser.add_argument("--lang", default="en-us")
    args = parser.parse_args()

    text = sys.stdin.read().strip()
    if not text:
        return

    kokoro = Kokoro(args.model, args.voices)

    async for samples, sample_rate in kokoro.create_stream(
        text, voice=args.voice, speed=args.speed, lang=args.lang
    ):
        # Convert float32 samples to int16 PCM
        pcm = (samples * 32767).astype(np.int16)
        sys.stdout.buffer.write(pcm.tobytes())
        sys.stdout.buffer.flush()

asyncio.run(main())
